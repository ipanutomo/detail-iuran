<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Iuran Warga</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #3498db;
            color: white;
            position: sticky;
            top: 0;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .total {
            font-weight: bold;
            margin-top: 10px;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Data Iuran Warga</h1>
        
        <div id="loading" class="loading">Memuat data...</div>
        <div id="total" class="total"></div>
        <div id="table-container">
            <table id="data-table">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Blok/No</th>
                        <th>Nama</th>
                        <th>Jenis Iuran</th>
                        <th>Periode</th>
                        <th>Tanggal</th>
                        <th>Iuran RW</th>
                        <th>Iuran RT</th>
                        <th>Takziyah</th>
                        <th>Kas</th>
                        <th>Lain-lain</th>
                        <th>Total</th>
                        <th>Keterangan</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Data akan diisi oleh JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
// 1. VARIABEL GLOBAL
let allData = [];
let filteredData = [];

// 2. FUNGSI PENDUKUNG
function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('id-ID');
}

function formatCurrency(amount) {
    if (amount === null || amount === undefined || isNaN(amount)) return '0';
    return parseInt(amount).toLocaleString('id-ID');
}

function sortDataByNewestDate(data) {
    return data.sort((a, b) => {
        const dateA = new Date(a.tanggal || 0);
        const dateB = new Date(b.tanggal || 0);
        return dateB - dateA; // Descending (newest first)
    });
}

// 3. FUNGSI UTAMA
async function loadData() {
    try {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('table-container').style.display = 'none';
        
        const response = await fetch('https://script.google.com/macros/s/AKfycbxEBiFSKRL2dwBHExY4eaPorC_6FXxVqftP9qx1e1dwrUmemA-UsDUksBBIYpNLCpuBbQ/exec');
        const result = await response.json();
        
        if (result.status === 'success') {
            allData = sortDataByNewestDate(result.data);
            filteredData = [...allData];
            renderTable();
            updateTotal();
        } else {
            alert('Gagal memuat data: ' + (result.message || 'Unknown error'));
        }
    } catch (error) {
        alert('Terjadi error: ' + error.message);
    } finally {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('table-container').style.display = 'block';
    }
}

function updateTotal() {
    const totalElement = document.getElementById('total');
    
    if (filteredData.length === 0) {
        totalElement.textContent = 'Total: 0 data';
        return;
    }
    
    // Hitung total berbagai jenis iuran
    const totals = filteredData.reduce((acc, item) => {
        acc.iuran_rw += parseInt(item.iuran_rw) || 0;
        acc.iuran_rt += parseInt(item.iuran_rt) || 0;
        acc.takziyah += parseInt(item.takziyah) || 0;
        acc.kas += parseInt(item.kas) || 0;
        acc.lain_lain += parseInt(item['lain_-_lain']) || 0;
        return acc;
    }, { iuran_rw: 0, iuran_rt: 0, takziyah: 0, kas: 0, lain_lain: 0 });
    
    const grandTotal = totals.iuran_rw + totals.iuran_rt + totals.takziyah + totals.kas + totals.lain_lain;
    
    totalElement.innerHTML = `
        Total: ${filteredData.length} data | 
        Iuran RW: Rp${formatCurrency(totals.iuran_rw)} | 
        Iuran RT: Rp${formatCurrency(totals.iuran_rt)} | 
        Takziyah: Rp${formatCurrency(totals.takziyah)} | 
        Kas: Rp${formatCurrency(totals.kas)} | 
        Lain-lain: Rp${formatCurrency(totals.lain_lain)} | 
        <strong>Grand Total: Rp${formatCurrency(grandTotal)}</strong>
    `;
}

function renderTable() {
    const tableBody = document.getElementById('table-body');
    tableBody.innerHTML = '';
    
    if (filteredData.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="13" style="text-align: center;">Tidak ada data yang ditemukan</td>`;
        tableBody.appendChild(row);
        return;
    }
    
    filteredData.forEach((item, index) => {
        const row = document.createElement('tr');
        const lainLain = item['lain_-_lain'] || 0;
        const kas = item.kas || 0;
        const total = (parseInt(item.iuran_rw) || 0) + 
                     (parseInt(item.iuran_rt) || 0) + 
                     (parseInt(item.takziyah) || 0) + 
                     (parseInt(kas) || 0) +
                     (parseInt(lainLain) || 0);
        
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>${item.blok_no || ''}</td>
            <td>${item.nama || ''}</td>
            <td>${item.jenis_iuran || ''}</td>
            <td>${item.periode || ''}</td>
            <td>${formatDate(item.tanggal)}</td>
            <td style="text-align: right;">${formatCurrency(item.iuran_rw)}</td>
            <td style="text-align: right;">${formatCurrency(item.iuran_rt)}</td>
            <td style="text-align: right;">${formatCurrency(item.takziyah)}</td>
            <td style="text-align: right;">${formatCurrency(kas)}</td>
            <td style="text-align: right;">${formatCurrency(lainLain)}</td>
            <td style="text-align: right; font-weight: bold;">${formatCurrency(total)}</td>
            <td>${item.keterangan || ''}</td>
        `;
        tableBody.appendChild(row);
    });
}

// 5. INITIALIZATION
document.addEventListener('DOMContentLoaded', () => {
    loadData();
});
    </script>
</body>
</html>
